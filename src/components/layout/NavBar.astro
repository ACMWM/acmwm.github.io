---
import "../../styles/navbar.css";
import logo from '../../../public/acm-logo.png';

interface Props {
  pageTitle?: string;
}

const navigationItems = [
  { name: "Home", url: "/" },
  { name: "About", url: "/about" },
  { name: "Events", url: "/events" },
  { name: "Connect", url: "/connect" },
];

const resourcesItems = [
  { name: "Tech clubs", url: "/resources/clubs" },
  { name: "How-to", url: "/resources/how-to" },
  { name: "ACM FAQ", url: "/resources/faq" },
];

const { pageTitle } = Astro.props;
const menuId = "acm-nav-menu";
---

<header class="simple-header" data-nav>
  <div class="header-content">
    <a href="/" title="Back to Home" class="brand-link" aria-label="W&M ACM home">
      <img src={logo.src} alt="ACM logo" class="brand-logo" />
      <span class="brand-text">W&amp;M ACM</span>
    </a>

    <button
      class="nav-toggle"
      type="button"
      aria-label="Open navigation menu"
      aria-controls={menuId}
      aria-expanded="false"
      data-nav-toggle
    >
      <span class="sr-only">Menu</span>
      <span class="hamburger" aria-hidden="true"></span>
    </button>

    <nav class="desktop-nav" aria-label="Primary navigation">
      <ul class="nav-list">
        {navigationItems.map((item) => (
          <li>
            <a href={item.url} class="nav-item">
              {item.name}
            </a>
          </li>
        ))}

        <li class="nav-dropdown" data-dd>
          <button
            type="button"
            class="nav-item nav-dropdown-trigger"
            aria-expanded="false"
            aria-haspopup="menu"
            data-dd-trigger
          >
            Resources
          </button>

          <div class="nav-dropdown-menu" aria-label="Resources" role="menu" data-dd-menu>
            {resourcesItems.map((item) => (
              <a href={item.url} class="nav-dropdown-item" role="menuitem">
                {item.name}
              </a>
            ))}
          </div>
        </li>
      </ul>
    </nav>
  </div>

  <nav class="mobile-nav" aria-label="Mobile navigation" id={menuId} data-nav-menu>
    <ul class="mobile-list">
      {navigationItems.map((item) => (
        <li>
          <a href={item.url} class="mobile-item">
            {item.name}
          </a>
        </li>
      ))}

      <li class="mobile-dropdown" data-dd>
        <button
          type="button"
          class="mobile-item mobile-dropdown-trigger"
          aria-expanded="false"
          aria-haspopup="menu"
          data-dd-trigger
        >
          Resources
        </button>

        <ul class="mobile-sublist" aria-label="Resources" data-dd-menu>
          {resourcesItems.map((item) => (
            <li>
              <a href={item.url} class="mobile-item mobile-subitem">
                {item.name}
              </a>
            </li>
          ))}
        </ul>
      </li>
    </ul>
  </nav>

  <script is:inline>
    {`
      function initAcmNav() {
        const header = document.querySelector('[data-nav]');
        const btn = document.querySelector('[data-nav-toggle]');
        const menu = document.querySelector('[data-nav-menu]');
        if (!header || !btn || !menu) return;

        const setMobileOpen = (open) => {
          if (open) header.setAttribute('data-open', '');
          else header.removeAttribute('data-open');
          btn.setAttribute('aria-expanded', open ? 'true' : 'false');
        };

        // avoid double-binding if astro fires multiple times
        if (header.dataset.bound === '1') return;
        header.dataset.bound = '1';

        btn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          const open = header.hasAttribute('data-open');
          setMobileOpen(!open);
        });

        menu.addEventListener('click', (e) => {
          const a = e.target.closest('a');
          if (a) setMobileOpen(false);
        });

        // dropdowns: click-to-open, close on click-out / escape
        const dropdowns = Array.from(header.querySelectorAll('[data-dd]'));
        const closeAllDropdowns = () => {
          dropdowns.forEach((dd) => {
            dd.removeAttribute('data-dd-open');
            const t = dd.querySelector('[data-dd-trigger]');
            if (t) t.setAttribute('aria-expanded', 'false');
          });
        };

        dropdowns.forEach((dd) => {
          const trigger = dd.querySelector('[data-dd-trigger]');
          const ddMenu = dd.querySelector('[data-dd-menu]');
          if (!trigger || !ddMenu) return;

          trigger.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();

            const isOpen = dd.hasAttribute('data-dd-open');
            closeAllDropdowns();

            if (!isOpen) {
              dd.setAttribute('data-dd-open', '');
              trigger.setAttribute('aria-expanded', 'true');
            }
          });

          ddMenu.addEventListener('click', (e) => {
            const a = e.target.closest('a');
            if (a) {
              closeAllDropdowns();
              setMobileOpen(false);
            }
          });
        });

        document.addEventListener('click', (e) => {
          if (!header.contains(e.target)) {
            closeAllDropdowns();
            setMobileOpen(false);
          }
        });

        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            closeAllDropdowns();
            setMobileOpen(false);
          }
        });
      }

      // initial load
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initAcmNav);
      } else {
        initAcmNav();
      }

      // astro client-side navigation (if enabled)
      document.addEventListener('astro:page-load', initAcmNav);
    `}
  </script>
</header>
